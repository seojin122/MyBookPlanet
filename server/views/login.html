{% extends 'layout.html' %}

{% block content %}
  {% if user %}
    <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê¸€ ì‘ì„± í¼ì„ ë³¼ ìˆ˜ ìˆë„ë¡ ì¡°ê±´ ì¶”ê°€ -->
    <input type="text" id="introContentInput" placeholder="ì§§ì€ ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”" />
    <button id="saveIntroButton">ì €ì¥</button>

    <div id="introListContainer">
      <!-- ì €ì¥ëœ ê¸€ë“¤ì´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>

    <!-- âœ… íŒŒì¼ ì—…ë¡œë“œ -->
    <input type="file" id="fileInput">
    <button id="uploadButton">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
    <br>
    <img id="previewImage" style="max-width: 100px; height: auto; display: none;">

  {% else %}
    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²ŒëŠ” í¼ì´ ë³´ì´ì§€ ì•ŠìŒ -->
  {% endif %}
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // âœ… ê¸°ì¡´ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì½”ë“œ ìœ ì§€
    if (document.getElementById('img')) {
        document.getElementById('img').addEventListener('change', function(e) {
            const formData = new FormData();
            console.log(this, this.files);
            formData.append('img', this.files[0]);
            axios.post('/post/img', formData)
                .then((res) => {
                    document.getElementById('img-url').value = res.data.url;
                    document.getElementById('img-preview').src = res.data.url;
                    document.getElementById('img-preview').style.display = 'inline';
                })
                .catch((err) => {
                    console.error(err);
                });
        });
    }

    document.querySelectorAll('.twit-follow').forEach(function(tag) {
        tag.addEventListener('click', function() {
            const myId = document.querySelector('#my-id');
            if (myId) {
                const userId = tag.parentNode.querySelector('.twit-user-id').value;
                if (userId !== myId.value) {
                    if (confirm('íŒ”ë¡œì‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        axios.post(`/user/${userId}/follow`)
                            .then(() => {
                                location.reload();
                            })
                            .catch((err) => {
                                console.error(err);
                            });
                    }
                }
            }
        });
    });

    // âœ… í•œì¤„ ì†Œê°œ ì €ì¥ ê¸°ëŠ¥ ìœ ì§€
    const saveIntroButton = document.getElementById("saveIntroButton");
    const introContentInput = document.getElementById("introContentInput");
    const introListContainer = document.getElementById("introListContainer");

    if (saveIntroButton) {
        saveIntroButton.addEventListener("click", async () => {
            const content = introContentInput.value;

            if (!content) {
                alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                const response = await fetch("/save-intro", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ content }),
                });

                if (!response.ok) {
                    throw new Error("ì„œë²„ ì˜¤ë¥˜");
                }

                const intros = await response.json();

                // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™” í›„ ìƒˆ ê¸€ ì¶”ê°€
                introListContainer.innerHTML = "";
                intros.forEach((intro) => {
                    const introElement = document.createElement("div");
                    introElement.textContent = intro.content;
                    introListContainer.appendChild(introElement);
                });

                // ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸°
                introContentInput.value = "";
            } catch (error) {
                console.error("Error saving intro:", error);
            }
        });
    }

    // âœ… ğŸ”¥ **í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ & ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìœ ì§€ë¨!)**
    const fileInput = document.getElementById("fileInput");
    const previewImage = document.getElementById("previewImage");
    const uploadButton = document.getElementById("uploadButton");

    // ğŸ“Œ **ì„œë²„ì—ì„œ í˜„ì¬ í”„ë¡œí•„ ì´ë¯¸ì§€ ê°€ì ¸ì™€ì„œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ**
    fetch("/user/profile")
        .then(response => response.json())
        .then(data => {
            if (data.profileImage) {
                previewImage.src = data.profileImage;
                previewImage.style.display = "block";
            }
        })
        .catch(error => console.error("í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜:", error));

    // ğŸ“Œ **íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸**
    fileInput.addEventListener("change", function () {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImage.src = e.target.result;
                previewImage.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    // ğŸ“Œ **íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ (ğŸ”¥ ê¸°ì¡´ `/users/profile-image` â†’ `/image/profile`ë¡œ ìˆ˜ì •)**
    uploadButton.addEventListener("click", function () {
        if (fileInput.files.length === 0) {
            alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }

        const formData = new FormData();
        formData.append("profileImage", fileInput.files[0]);

        fetch("/image/profile", {  // âœ… ì˜¬ë°”ë¥¸ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
            method: "POST",
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();  // ìƒˆë¡œê³ ì¹¨
            } else {
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + data.message);
            }
        })
        .catch(error => {
            console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
            alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    });
});
</script>
{% endblock %}
